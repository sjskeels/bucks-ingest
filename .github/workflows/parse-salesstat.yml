name: Buck's Parse SalesStat (3AM + Noon Chicago)

on:
  schedule:
    # Cron is UTC. We run 4 times/day and gate to 03:xx or 12:xx America/Chicago (DST-safe).
    - cron: "5 8,9,17,18 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: "latest | by_date"
        required: false
        default: "latest"
      business_date:
        description: "YYYY-MM-DD (required if mode=by_date)"
        required: false

concurrency:
  group: parse-salesstat
  cancel-in-progress: false

jobs:
  parse-salesstat:
    runs-on: ubuntu-latest
    env:
      PARSE_URL: ${{ secrets.PARSE_URL }}
      PARSE_TOKEN: ${{ secrets.PARSE_TOKEN }}
      MODE: ${{ github.event.inputs.mode }}
      BUSINESS_DATE: ${{ github.event.inputs.business_date }}

    steps:
      - name: Validate secrets present
        run: |
          set -euo pipefail
          if [ -z "${PARSE_URL:-}" ] || [ -z "${PARSE_TOKEN:-}" ]; then
            echo "Missing GitHub Secrets: PARSE_URL and/or PARSE_TOKEN"
            exit 1
          fi

      - name: Gate to 3AM + Noon America/Chicago (DST-safe)
        id: gate
        run: |
          set -euo pipefail
          HOUR="$(TZ=America/Chicago date +%H)"
          echo "Local hour (America/Chicago): ${HOUR}"

          # Only gate scheduled runs. Manual workflow_dispatch runs should always execute.
          if [ "${GITHUB_EVENT_NAME}" = "schedule" ]; then
            if [ "${HOUR}" != "03" ] && [ "${HOUR}" != "12" ]; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "Not 03 or 12 in Chicago; skipping parse."
              exit 0
            fi
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Parse SalesStat
        if: steps.gate.outputs.skip != 'true'
        run: |
          set -euo pipefail

          MODE="${MODE:-latest}"
          BUSINESS_DATE="${BUSINESS_DATE:-}"

          echo "Mode: ${MODE}"

          if [ "${MODE}" = "by_date" ]; then
            if [ -z "${BUSINESS_DATE}" ]; then
              echo "business_date is required when mode=by_date"
              exit 1
            fi
            URL="${PARSE_URL}/parse/salesstat/by-date?business_date=${BUSINESS_DATE}"
          else
            URL="${PARSE_URL}/parse/salesstat/latest"
          fi

          echo "URL: ${URL}"

          RESP="$(curl -sS -X POST -H "X-Parse-Token: ${PARSE_TOKEN}" "${URL}")"
          echo "Raw response:"
          echo "${RESP}"

          echo "${RESP}" | grep -q '"ok":true' && echo "OK: Parse succeeded." || (echo "ERROR: Parse failed" && exit 1)
