import os
import hashlib
from datetime import datetime, timezone

from flask import Flask, request, jsonify
import psycopg  # psycopg v3 (pure python installs cleanly)

app = Flask(__name__)

def db_conn():
    dsn = os.environ.get("DATABASE_URL")
    if not dsn:
        raise RuntimeError("DATABASE_URL is not set")
    # psycopg wants postgres:// or postgresql://; Railway uses postgresql:// typically
    return psycopg.connect(dsn, autocommit=True)

@app.get("/")
def health():
    return jsonify(ok=True)

@app.post("/mailgun/inbound")
def inbound():
    """
    Mailgun will POST multipart/form-data.
    We accept:
      - file field(s) that are PDFs
      - minimal metadata
    """
    # 1) Grab first attachment that looks like a PDF
    pdf_bytes = None
    filename = None
    content_type = None

    # Mailgun commonly uses 'attachment-1', 'attachment-2', etc.
    for key, storage in request.files.items():
        ct = storage.content_type or ""
        name = storage.filename or "attachment.pdf"
        if ct.lower() == "application/pdf" or name.lower().endswith(".pdf"):
            pdf_bytes = storage.read()
            filename = name
            content_type = ct or "application/pdf"
            break

    # If no attachment, still return 200 so Mailgun doesnâ€™t retry forever
    if not pdf_bytes:
        return "ok (no pdf found)", 200

    sha256 = hashlib.sha256(pdf_bytes).hexdigest()

    mail_from = request.form.get("from", "")
    mail_subject = request.form.get("subject", "")
    mail_message_id = request.form.get("Message-Id", "") or request.form.get("message-id", "")

    # 2) Insert into raw.inbound_files (minimal fields)
    # NOTE: report_type/business_date can be filled later by parsing filename/subject/pdf.
    with db_conn() as conn:
        with conn.cursor() as cur:
            cur.execute(
                """
                INSERT INTO raw.inbound_files
                  (received_at, mail_from, mail_subject, mail_message_id,
                   filename, content_type, file_bytes, sha256)
                VALUES
                  (%s, %s, %s, %s,
                   %s, %s, %s, %s)
                ON CONFLICT (sha256) DO NOTHING
                """,
                (
                    datetime.now(timezone.utc),
                    mail_from,
                    mail_subject,
                    mail_message_id,
                    filename,
                    content_type,
                    psycopg.Binary(pdf_bytes),
                    sha256,
                ),
            )

    return "ok", 200
